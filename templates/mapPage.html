{% load static %}
<!DOCTYPE html>
<html lang="en">

<!--head start-->

<head>
    <!--meta tag start-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--title-->
    <title>Bipad</title>

    <!-- faveicon start   -->
    <link rel="icon" type="image/png" href="{% static 'mappage/images/favicon.png' %}" sizes="32x32">

    <!-- stylesheet start -->

    <link rel="stylesheet" type="text/css" href="{% static 'mappage/css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mappage/css/customfonts.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mappage/css/ionicons.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mappage/css/c3.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin="" />
    <link rel="stylesheet" type="text/css" href="{% static 'mappage/css/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mappage/css/leaflet.draw.css' %}">


</head>
<!--head end-->

<body>
    <!-- bipad start -->
    <div class="bipadContent">

        <!-- mapsection start -->
        <div class="mapwrap">

            <!-- logo start -->
            <div class="bipad-logo">
                <h1 class="logo"><a href="index.html">Bipad</a></h1>
                <span class="sub-logo">RiskInfo</span>
            </div>

            <!-- map start -->
            <div id="mapid"></div>

            <!-- right navigation -->
            <div class="right-nav">
                <div class="nav-wrap">
                    <ul>
                        <li><a href="#"><i class="ion ion-md-home"></i><span>Dashboard</span></a></li>
                        <li><a href="#"><i class="ion ion-ios-warning"></i><span>Incidents</span></a></li>
                        <li class="active"><a href="#"><i class="ion ion-ios-map"></i><span>Risk information</span></a></li>
                        <li><a href="#"><i class="ion ion-md-alarm"></i><span>Loss & Damage</span></a></li>
                        <li><a href="#"><i class="ion ion-ios-stopwatch"></i><span>Real Time</span></a></li>
                        <li><a href="#"><i class="ion ion-md-briefcase"></i><span>profile mapping</span></a></li>
                        <li><a href="#"><i class="ion ion-md-information-circle"></i><span>about us</span></a></li>
                    </ul>
                </div>
                <div class="buffer-icon">
                    <span class="ion ion-logo-buffer"></span>
                </div>
            </div>

             <!-- map layer list -->
             <div class="buffer-list">
                <div class="buffer-header">
                    <h4>Maplayer</h4>
                    <span><i class="ion ion-md-close"></i></span>
                </div>
                <ul>
                    <li class="light"><a href="#">Light</a></li>
                    <li class="street"><a href="#">street</a></li>
                    <li class="outdoor"><a href="#">outdoor</a></li>
                    <li class="satelite"><a href="#">satelite</a></li>
                    <li class="road"><a href="#">Roads</a></li>
                </ul>
            </div>

            <!-- leftSidebar start -->
            <div class="sidebar leftSidebar">
                <span class="expand-icon">
                    <i class="ion ion-ios-warning"></i>
                </span>
                <div class="sidebarwrapper">

                    <!-- sidebar start -->
                      <div class="sidebar-widget grid-widget">

                            <!-- <h5>chart</h5> -->
                            <div id="chart"></div>

                      </div>

                      <div class="sidebar-widget grid-widget" id="filtered_layer_list_container" style="display:none;">

                        <div class="leftSidebar-header">
                            <h4>Incidents</h4>
                        </div>
                        <ul class="list-content" id='filtered_layer_list'>

                        </ul>

                      </div>



                    <div class="sidebar-widget grid-widget">
                      <div class="leftSidebar-header">
                          <h4>Service</h4>
                          <button type="button" class="button dataShow"><i class=" ion ion-ios-expand"></i></button>
                          <button type="button" class="button sidebarClose arrow-open"><i class=" ion ion-ios-arrow-up"></i></button>
                      </div>
                        <div class="row">

                            {% for resource in resources %}
                            <div class="col-xl-6">
                                <div class="facility-item">
                                    <a href="#">
                                        <div class="icon">
                                            <i class="{{resource.layer_icon}}"></i>
                                        </div>
                                        <span>{{resource.count_obj}}</span>
                                        <h5>{{resource.layer_name}}</h5>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                    </div>
                    <div class="sidebar-widget">
                        <div class="leftSidebar-header">
                            <h4>Incidents</h4>
                        </div>
                        <ul class="list-content">
                            <li><a href="#" target="">Total population</a><span>113456</span></li>
                            <li><a href="#" target="">Area (sq/km)</a><span>43634</span></li>
                            <li><a href="#" target="">population density</a><span>4567789</span></li>
                            <li><a href="#" target="">Poverty rate</a><span>57568569</span></li>
                            <li><a href="#" target="">Population under poverty rate</a><span>5685698</span></li>
                            <li><a href="#" target="">HD</a><span>45363</span></li>
                            <li><a href="#" target="">GDP</a><span>769768</span></li>
                            <li><a href="#" target="">Index</a><span>45363</span></li>
                            <li><a href="#" target="">Per income</a><span>769768</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- rightSidebar start -->
            <div class=" sidebar rightSidebar">
                <span class="expand-icon">
                    <i class="ion ion-md-funnel"></i>
                </span>
                <div class="sidebarwrapper">
                    <!-- sidebar start -->
                    <div class="sidebar-widget filter-widget">
                        <div class="leftSidebar-header">
                            <h4>Filters</h4>
                            <button type="button" class="button sidebarClose"><i class=" ion ion-ios-arrow-up"></i></button>
                        </div>
                        <div class="filterSelect">
                            <h5>Admin level</h5>
                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="province-tab" data-toggle="tab" href="#province" role="tab" aria-controls="province" aria-selected="true">province</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="district-tab" data-toggle="tab" href="#district" role="tab" aria-controls="district" aria-selected="false">District</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="municipality-tab" data-toggle="tab" href="#municipality" role="tab" aria-controls="municipality" aria-selected="false">municipality</a>
                                </li>
                            </ul>
                            <div class="tab-content" id="myTabContent">
                                <div class="tab-pane fade show active" id="province" role="tabpanel" aria-labelledby="province-tab">
                                    <h5>Province</h5>
                                    <div class="select-option">
                                        <select class="custom-select">
                                            <option selected>Province one</option>
                                            <option>Province one</option>
                                            <option>Province two</option>
                                            <option>Province three</option>
                                            <option>Province four</option>
                                            <option>Province five</option>
                                            <option>Province six</option>
                                            <option>Province seven</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="district" role="tabpanel" aria-labelledby="district-tab">
                                    <h5>District</h5>
                                    <div class="select-option">
                                        <select class="custom-select">
                                            <option selected>Province one</option>
                                            <option>Province one</option>
                                            <option>Province two</option>
                                            <option>Province three</option>
                                            <option>Province four</option>
                                            <option>Province five</option>
                                            <option>Province six</option>
                                            <option>Province seven</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="municipality" role="tabpanel" aria-labelledby="municipality-tab">
                                    <h5>municipality</h5>
                                    <div class="select-option">
                                        <select class="custom-select">
                                            <option selected>Province one</option>
                                            <option>Province one</option>
                                            <option>Province two</option>
                                            <option>Province three</option>
                                            <option>Province four</option>
                                            <option>Province five</option>
                                            <option>Province six</option>
                                            <option>Province seven</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- vulnerability-widget start -->
                    <div class="sidebar-widget hazards-widget">
                        <div class="widget-title">
                            <h5>hazards</h5>
                        </div>
                        <div class="iconwrap">
                            <ul>
                              <li class='earthquake_risk_activeclass'>
                                  <a href="#" data-toggle="tooltip" data-placement="bottom" title="earthquake_risk" class="CheckBox" value="earthquake_risk" data-url="" data-workspace=""><span><i class="humanitarian-icon-Earthquake"></i></span>Earthquake Risk</a>
                              </li>
                                {% for hazard in hazards|slice:":2" %}
                                <li class='{{hazard.layer_tbl}}_activeclass'>
                                    <a href="#" data-toggle="tooltip" data-placement="bottom" title="{{hazard.layer_name}}" class="CheckBox" value="{{hazard.layer_tbl}}" data-url="{{hazard.geoserver_url}}" data-workspace="{{hazard.geoserver_workspace}}"><span><i class="humanitarian-icon-Earthquake"></i></span> {{hazard.layer_name}}</a>
                                </li>
                                {% endfor %}
                                <li>
                                    <a data-tab="hazardtab" class="more-option"><span><i class="humanitarian-icon-More-options"></i></span>See more</a>

                                </li>
                            </ul>
                            <!-- menu-list start -->
                            <div class="icon-submenu" id="hazardtab">
                                <ul class="dropicons-list">
                                    <span class="close-cion">x</span>
                                    {% for hazard in hazards|slice:"2:" %}
                                    <li class='{{hazard.layer_tbl}}_activeclass'>
                                        <a href="#" data-toggle="tooltip" data-placement="bottom" title="{{hazard.layer_name}}" class="CheckBox" value="{{hazard.layer_tbl}}" data-url="{{hazard.geoserver_url}}" data-workspace="{{hazard.geoserver_workspace}}"><span><i class="{{hazard.layer_icon}}"></i></span>  {{hazard.layer_name}}</a>
                                    </li>

                                    {% endfor %}


                                </ul>
                            </div>

                        </div>
                    </div>
                    <!-- exposure-widget start -->
                    <div class="sidebar-widget hazards-widget">
                        <div class="widget-title">
                            <h5>VULNERABILITY</h5>
                        </div>
                        <div class="iconwrap">
                            <ul>

                                {% for vulnerability in vulnerabilities|slice:":2" %}
                                <li class='{{vulnerability.layer_tbl}}_activeclass'>
                                    <a  data-tab="glacier" data-toggle="tooltip" data-placement="bottom" title="{{vulnerability.layer_name}}" class="CheckBox" value="{{vulnerability.layer_tbl}}" data-url="{{vulnerability.geoserver_url}}" data-workspace="{{vulnerability.geoserver_workspace}}"><span><i class="{{vulnerability.layer_icon}}"></i></span> {{vulnerability.layer_name}}</a>
                                </li>

                                {% endfor %}

                                <li>
                                    <a data-tab="earthquake" class="more-option" data-toggle="tooltip" data-placement="bottom" title="See more"><span><i class="humanitarian-icon-More-options"></i></span>See more</a>
                                </li>
                            </ul>
                            <div class="icon-submenu submenu-list" id="glacier">
                                <ul>
                                    <span class="close-cion">x</span>
                                    <li class="drop-list">
                                        <a href="#" > Earthquake1</a>
                                        <ul>
                                            <li class="drop-list subdrop-list">
                                                <a href="#" > Earthquake2</a>
                                                <ul>
                                                    <li>
                                                        <a href="#" > Earthquake3</a>
                                                    </li>
                                                    <li>
                                                        <a href="#">Earthquake4</a>
                                                    </li>
                                                    <li>
                                                        <a href="#">Landslide5</a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li>
                                                <a href="#"><label><input type="checkbox" value="">Option 3</label></a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide6</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="drop-list">
                                        <a href="#"  >Earthquake7</a>
                                        <ul>
                                            <li>
                                                <a href="#" > Earthquake8</a>
                                            </li>
                                            <li>
                                                <a href="#"  >Earthquake9</a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide10</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="drop-list">
                                        <a href="#">Landslide11</a>
                                        <ul>
                                            <li>
                                                <a href="#" > Earthquake12</a>
                                            </li>
                                            <li>
                                                <a href="#"  >Earthquake13</a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide14</a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="icon-submenu submenu-list" id="flood">
                                <ul>
                                    <span class="close-cion">x</span>
                                    <li class="drop-list">
                                        <a href="#" > Earthquake</a>
                                        <ul>
                                            <li class="drop-list subdrop-list">
                                                <a href="#" > Earthquake</a>
                                                <ul>
                                                    <li>
                                                        <a href="#" > Earthquake</a>
                                                    </li>
                                                    <li>
                                                        <a href="#">Earthquake</a>
                                                    </li>
                                                    <li>
                                                        <a href="#">Landslide</a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li>
                                                <a href="#"><label><input type="checkbox" value="">Option 3</label></a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="drop-list">
                                        <a href="#"  >Earthquake</a>
                                        <ul>
                                            <li>
                                                <a href="#" > Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#"  >Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="drop-list">
                                        <a href="#">Landslide</a>
                                        <ul>
                                            <li>
                                                <a href="#" > Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#"  >Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide</a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="icon-submenu submenu-list" id="landslide">
                                <ul>
                                    <span class="close-cion">x</span>
                                    <li class="drop-list">
                                        <a href="#" > Earthquake</a>
                                        <ul>
                                            <li class="drop-list subdrop-list">
                                                <a href="#" > Earthquake</a>
                                                <ul>
                                                    <li>
                                                        <a href="#" > Earthquake</a>
                                                    </li>
                                                    <li>
                                                        <a href="#">Earthquake</a>
                                                    </li>
                                                    <li>
                                                        <a href="#">Landslide</a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li>
                                                <a href="#"><label><input type="checkbox" value="">Option 3</label></a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="drop-list">
                                        <a href="#"  >Earthquake</a>
                                        <ul>
                                            <li>
                                                <a href="#" > Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#"  >Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="drop-list">
                                        <a href="#">Landslide</a>
                                        <ul>
                                            <li>
                                                <a href="#" > Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#"  >Earthquake</a>
                                            </li>
                                            <li>
                                                <a href="#">Landslide</a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="icon-submenu" id="earthquake">
                                <ul class="dropicons-list">
                                    <span class="close-cion">x</span>
                                    {% for vulnerability in vulnerabilities|slice:"2:" %}
                                    <li class='{{vulnerability.layer_tbl}}_activeclass'>
                                            <a href="#" data-toggle="tooltip" data-placement="bottom" title="{{vulnerability.layer_name}}" class="CheckBox" value="{{vulnerability.layer_tbl}}" data-url="{{vulnerability.geoserver_url}}" data-workspace="{{vulnerability.geoserver_workspace}}"><span><i class="{{vulnerability.layer_icon}}"></i></span>  {{vulnerability.layer_name}}</a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>

                        </div>
                    </div>
                    <!-- hazard-widget start -->
                    <div class="sidebar-widget hazards-widget">
                            <div class="widget-title">
                                <h5>exposure</h5>
                            </div>
                            <div class="iconwrap">
                                <ul class="four-list">

                                        {% for exposure in exposures|slice:":2" %}
                                    <li class='{{exposure.layer_tbl}}_activeclass'>
                                            <a href="#" data-toggle="tooltip" data-placement="bottom" title="{{exposure.layer_name}}" class="CheckBox" value="{{exposure.layer_tbl}}" data-url="{{exposure.geoserver_url}}" data-workspace="{{exposure.geoserver_workspace}}"><span><i class="{{exposure.layer_icon}}"></i></span>{{ exposure.layer_name}}</a>

                                    </li>

                                    {% endfor %}


                                    <li>
                                        <a data-tab="exposuretab" class="more-option"><span><i class="humanitarian-icon-More-options"></i></span>See more</a>

                                    </li>
                                </ul>
                                <div class="icon-submenu" id="exposuretab" >
                                    <ul class="dropicons-list">
                                        <span class="close-cion">x</span>
                                        {% for exposure in exposures|slice:"2:" %}
                                        <li class='{{exposure.layer_tbl}}_activeclass'>
                                            <a href="#" data-toggle="tooltip" data-placement="bottom" title="{{exposure.layer_name}}" class="CheckBox" value="{{exposure.layer_tbl}}" data-url="{{exposure.geoserver_url}}" data-workspace="{{exposure.geoserver_workspace}}"><span><i class="humanitarian-icon-Earthquake"></i></span> {{exposure.layer_name}}</a>
                                        </li>

                                        {% endfor %}


                                    </ul>
                                </div>
                            </div>
                        </div>
                    <!-- capacity-widget start -->
                    <div class="sidebar-widget capacity-widget">
                            <h5>capacity & resources</h5>
                        <ul class="list-content">
                            {% for resource in resources %}
                            <li class='{{resource.layer_tbl}}_activeclass'>
                                <div class="capacity-content">
                                    <div class="capacity-icon CheckBox" value="{{resource.layer_tbl}}" data-url="{{resource.geoserver_url}}" data-workspace="{{resource.geoserver_workspace}}" data-subcat="{{resource.sub_category}}">
                                        <span><i class="{{resource.layer_icon}}"></i></span>
                                        {{resource.layer_name}} {{reaource.subCategory}}
                                    </div>
                                    <div class="capacity-tag">
                                            {% for cat in resource.list_string %}
                                            <a href="#" value='{{cat}}' class="subcat {{resource.layer_name}}_subcat geoserver_{{resource.isGeoserver}}">{{ cat }}</a>

                                        {% endfor %}
                                    </div>
                                </div>
                            </li>
                            {% endfor %}



                        </ul>
                    </div>
                </div>
            </div>
            <!-- rightSidebar end -->
            <div class="data-sidebar">
                <div class="sidebarwrapper">
                    <div class="leftSidebar-header">
                        <h4>Data visualization</h4>
                        <button type="button" class="button dataShow"><i class=" ion ion-ios-expand"></i></button>
                        <button type="button" class="button sidebarClose"><i class=" ion ion-ios-arrow-up"></i></button>
                    </div>
                    <div class="container-fluid">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-header">
                                    <h5>Health Facilities</h5>
                                </div>
                                <div class="health-facility">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div id="chart-pie" class="c3_chart"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <div id="chart-bar-rotated" class="c3_chart"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <div id="chart-bar" class="c3_chart"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="acadamic-facility">
                                <div class="card-header">
                                        <h5>Acadamic Institutions</h5>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div id="acadamic-spiline" class="c3_chart"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <div id="chart-area-spline-sracked" class="c3_chart"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <div id="lineGraph" class="c3_chart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- mapsection end -->
    </div>
    <!-- bipad end -->



    <!-- js library start -->
    <script src="{% static 'mappage/js/jquery-3.3.1.min.js' %}"></script>
    <script src="{% static 'mappage/js/popper.min.js' %}"></script>
    <script src="{% static 'mappage/js/bootstrap.min.js' %}"></script>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
    <script src="{% static 'mappage/js/jquery.slimscroll.min.js' %}"></script>
   <!-- <script src="{% static 'mappage/js/map.js' %}"></script> -->
    <script src="{% static 'mappage/js/script.js' %}"></script>
    <script src="{% static 'mappage/js/L.TileLayer.BetterWMS.js' %}"></script>
    <script src="{% static 'mappage/js/chart.js' %}"></script>
    <script src="{% static 'mappage/js/d3.min.js' %}"></script>
	<script src="{% static 'mappage/js/c3.js' %}"></script>
	<script src="{% static 'mappage/js/leaflet.draw.js' %}"></script>
	<script src="{% static 'mappage/js/proj4.js' %}"></script>
	<script src="{% static 'mappage/js/leaflet-wfst.src.js' %}"></script>
  //chart-pie
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!-- FusionCharts -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js"></script>

  //chart

    <script>
            //
            var base_url= 'http://139.59.67.104:8004'
          //  var base_url = 'http://localhost:8000'
            $(document).ready(function(){
            map = L.map('mapid',{
                     zoomControl:false
                   }).setView([28.410728397237914,84.4024658203125], 7);
                  map.attributionControl.addAttribution("<a href='http://www.naxa.com.np' title = 'Contributor'>NAXA</a>");
                  // map.scrollWheelZoom.disable();
                  map.options.maxBounds;  // remove the maxBounds object from the map options
                  //map.options.minZoom = 9;
                  map.createPane("polygonsPane").style.zIndex = 620;
                  map.createPane("baseLayerPane").style.zIndex = 250;
                  map.createPane("wmsPane").style.zIndex = 450;
                  map.createPane("linesPane").style.zIndex = 620;
                  map.createPane("pointsPane").style.zIndex = 800;
                  //map.options.minZoom = 14;
                  //console.log("adfasfsadfasfasdfasfdasdfsafasdfsafasfasfsafsa");
                  var accessToken = "pk.eyJ1IjoidXBlbmRyYW9saSIsImEiOiJjaWYwcnFnNmYwMGY4dGZseWNwOTVtdW1tIn0.uhY72SyqmMJNTKa0bY-Oyw";
             var mapboxTiles = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token='+accessToken, {
                   attribution: '© <a href="https://www.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
                  var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                    pane:"baseLayerPane"
                  });
                  googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                    maxZoom: 20,
                    subdomains:['mt0','mt1','mt2','mt3'],
                    pane:"baseLayerPane"
                  });
                  googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
                    maxZoom: 20,
                    subdomains:['mt0','mt1','mt2','mt3'],
                    pane:"baseLayerPane"
                  });
                  googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                    maxZoom: 20,
                    subdomains:['mt0','mt1','mt2','mt3'],
                    pane:"baseLayerPane"
                  });
                  googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
                    maxZoom: 20,
                    subdomains:['mt0','mt1','mt2','mt3'],
                    pane:"baseLayerPane"
                  });
            //console.log(wmsLayers_print.length);
            // $.each(wmsLayers_print, function (i) {
            //   var url = 'http://139.59.67.104:8080/geoserver/wms';
            //
            //         L.tileLayer.betterWms(url, {
            //           layers: wmsLayers_print[i].url,
            //           transparent: true,
            //           format: 'image/png'
            //         }).addTo(map);
            resources_layer=[
              'airports',
              'bridges',
              'education',
              'financial_institutions',
              'health_facilities',
              'hotels',
              'market_centers',
              'medical_point',
              'police_stations',
              'banks',
              'places',
              'cities',
              'place_of_worship',
            ]
            resources_icon=[
              'humanitarian-icon-Airport',
              'humanitarian-icon-Bridge',
              'humanitarian-icon-Education',
              'humanitarian-icon-Financing',
              'humanitarian-icon-Hospital',
              'humanitarian-icon-Hotel',
              'humanitarian-icon-IDP-refugee-camp',
              'humanitarian-icon-Medical-supply',
              'humanitarian-icon-Police-station',
              'humanitarian-icon-Cash-transfer',
              'humanitarian-icon-Rural',
              'humanitarian-icon-Building',
              'humanitarian-icon-Hindu-temple',
            ];
            vulnerability_layer=[
                'district_risk_score',
                //'district_risk_rank',
                'district_hdi',
                'district_remotness',
                'district_specificity',
                'district_maxm_facilities',
                'district_median_facilities',
            ];

            //image layer

         var earthquake_risk = L.tileLayer('https://maps.openquake.org/tiles/ghm/wmts/seismic-hazard-pga-g/webmercator/{z}/{x}/{y}.png', {
         // trick: expose name via options, used in events
         name: 'Seismic Hazard PGA (g)',
         overlay: true,
         attribution: '',
         legend: true,
         printable: true,
         zIndex:9996,
         ext: '/media/ext/js/global-hazard.js',

         maxZoom: 15,
         minZoom: 2,
     });

     //end



            var popup = new L.Popup({offset:[0,-20]});
            $.get(base_url+'/risk_profile/Layer',function(data){
                count = 0;
                // console.log(data.results.length);
                for(var i=0;i<data.results.length;i++){
                    if( data.results[i]['isGeoserver']== true) {
                        var url = data.results[i]['geoserverUrl']
                        //'http://139.59.67.104:8080/geoserver/wms';
                        window[data.results[i]['layerTbl']]=L.tileLayer.betterWms(url, {
                            layers:  data.results[i]['geoserverWorkspace']+ ':'+ data.results[i]['layerTbl'],
                            transparent: true,
                            format: 'image/png',
                            pane:"wmsPane"
                      });
                    }
                    else{
                        if(data.results[i]['subCategory'] == null){
                          var sub_array=[];
                        }
                        else{
                        //  console.log(data.results[i]['subCategory']);
                            var sub_array = data.results[i]['subCategory'].split(",");
                             //console.log(sub_array);
                            for(let i=0;i<sub_array.length;i++){
                                //console.log("w",window[sub_array[i]])
                                window[sub_array[i].replace(' ','_')] = L.layerGroup();
                                //console.log("w",window[sub_array[i]])
                            }
                        }
                        layer_icon= data.results[i]['layerIcon']
                        //alert(layer_icon)
                        // console.log("print data ",data);
                        var url =base_url+"/risk_profile/"+ data.results[i]['layerTbl'];
                        $.ajax({
                            url: url,
                            //data:{"layer_icon":layer_icon, "data":data,"i":i},
                            data1:data,
                            indexValue: i,
                            layer_icon: layer_icon,
                            success: function(response) {


                                //var data = data;
                              //  console.log(response);
                                // console.log("results",this.data1);
                                // console.log(this.layer_icon);
                                var layer_icon1 = this.layer_icon;
                                // console.log(this.indexValue);
                                //var geojson_data = JSON.parse(response);
                                // console.log(this.data1.results[this.indexValue]);
                        window[this.data1.results[this.indexValue]['layerTbl']] = new L.geoJson(response,
                        {
                            //pane:"pointsPane",
                            pointToLayer: function(feature,Latlng)
                                {
                                  //  console.log(layer_icon1)
                                    /* if( layer_icon != 'null'){ */
                                                    //alert(layer_icon)
                                        var divicon = L.divIcon({
                                            className: layer_icon1
                                            //iconSize: [80, 30],
                                            //html: '<i class='+ "fill_icon" + '></i>'
                                        });
                                        var marker = L.marker(Latlng,{icon:divicon});
                                    //}
                                   /*  else{
                                        var marker = L.circleMarker(Latlng);
                                    } */
                                    //for(data in style){
                                /* } */
                                //	}
                                return marker;
                                },
                                onEachFeature: function (feature, layer) {
                                    for(let i=0;i<sub_array.length;i++){
                                        if(sub_array[i]== feature.properties.type){
                                            layer.addTo(window[sub_array[i].replace(' ','_')])

                                        //    console.log('lg',window[sub_array[i].replace(' ','_')])
                                        }
                                    }
                                    // console.log("feat",feature.properties.type)
                                    if(feature.properties.type != undefined){
                                    }
                                    var popUpContent = "";
                                    popUpContent += '<table style="width:100%;" id="District-popup" class="popuptable">';
                                    // console.log(feature);
                                    for (data in layer.feature.properties) {
                                        //var dataspaced = underscoreToSpace(data);
                                        //console.log(data);
                                        popUpContent += "<tr>" + "<td>" + data + "</td>" + "<td>" + "  " + layer.feature.properties[data] + "</td>" + "</tr>";
                                        //console.log(popUpContent);
                                   }
                                    popUpContent += '</table>';
                                    //console.log(popUpContent);
                                    //layer.bindLabel(feature.properties['DISTRICT'], { 'noHide': true, id:"labelDiv" });
                                    layer.bindPopup(L.popup({
                                        //closeOnClick: true,
                                        //closeButton: true,
                                        keepInView: true,
                                        autoPan: true,
                                        maxHeight: 200,
                                        minWidth: 250
                                    }).setContent(popUpContent));
                                    layer.on('mouseover',function(e){
                                        //this.openPopup()
                                    })
                                    .on('mouseout',function(e){
                                        //this.closePopup()
                                    })
                                    /* layer.on("mouseover", function (e) {
                                             e.target.setStyle({weight:2});
                                             $("#labelDiv").html("<table class='popuptable'><tr><td><h5><b>Layer:</b> District</h5></td></tr><tr><td><h5><b>Name:</b> "+feature.properties['DISTRICT']+"</h5></td><tr></table>");
                                    }).on("mouseout", function(e){
                                             e.target.setStyle({weight:1});
                                             $("#labelDiv").html("");
                                    }); */
                                }
                            });
                            // window[data.results[i]['layerName']].on('data:loaded', function (data) {
                            //     alert(layer_icon);
                            //     window[data.results[i]['layerName']].setStyle({
                            //             fillColor: 'blue',
                            //             weight: 1,
                            //             opacity: 1,
                            //             color: 'black',
                            //             dashArray: '3',
                            //             fillOpacity: 0.0
                            //     });
                            //     $('.fill_icon').attr('class',layer_icon);
                            // });
                        }
                        });

                    }
                    count++;
            }
            });
              //var wmsLayer = L.tileLayer.wms('https://geonepal.info/geoserver/ows?', {
            // window[wmsLayers_print[i].name] = L.tileLayer.wms('http://139.59.67.104:8080/geoserver/ows?', {
            //   layers: wmsLayers_print[i].url,
            //   transparent: true,
            //   format: 'image/png'
            //
            // }).addTo(map);
            //});
                  //var none = "";
                  var baseLayers = {
                    "OpenStreetMap": osm,
                    "Google Streets": googleStreets,
                    "Google Hybrid": googleHybrid,
                    "Google Satellite": googleSat,
                    "Google Terrain": googleTerrain//,
                    //"None": none
                  };
                  //map.addLayer(googleStreets);


                  //layerswitcher = L.control.layers(baseLayers, {}, {collapsed: false}).addTo(map);




                  // map.on("load",function(){
                  //   console.log("map loaded fully");
                  // });
                  // setTimeout(function(){
                  //     googleStreets.sendToBack();
                  //  }, 3000);
                //map panes
                    //cat map end
                    info = L.control().setPosition('bottomleft');
                    info.onAdd = function (map) {
                          this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
                          //this._div.innerHTML="<h1>legend</h1>"

                          return this._div;
                      }
                      info.addTo(map);
                      //console.log($('.sidebarwrapper').css('display'));
                  //$('.info.leaflet-control').css('margin-right','700px');
                  $(".leaflet-left").css('display','block')
                  $('.leaflet-left').css('margin-left','380px');
                  $(".sidebarClose").on("click",function(){

                        $('.leaflet-left').css('margin-left','35px');


                  });

                  $(".expand-icon").on("click",function(){
                    $('.leaflet-left').css('display','none');


                  })

                    //function chart-bar
                    function  CreateChartData(geojson,subcat){

                      console.log(subcat);
                      console.log(geojson);
                      features=geojson.features;
                      subcat_arr=subcat.split(",");
                      console.log(subcat_arr);
                        var chartData=[];
                        //subcat_arr_count =[];
                        for(var k=0;k<subcat_arr.length;k++){
                          //subcat_arr_count[k][subcat_arr[k]+"_count"] = 0;
                          chartData.push({"label":subcat_arr[k].trim(),"count":0});

                        }

                        $.each(features, function (feature) {
                          for(var i=0;i<subcat_arr.length;i++){

                            if(subcat_arr[i].trim()==features[feature].properties.type.trim()){
                              chartData[i].count++;


                            }

                          }



                        });
                        console.log(chartData);
                        createChart(chartData);
                      }
                    //chart end

                    visible_layers=[];
                    // request layer data
                    $(".CheckBox").on('click',function(){
                      layerName=$(this).attr('value');
                      var geo_url= $(this).attr("data-url");
                      var geo_workspace =$(this).attr("data-workspace");
                      var subcat =$(this).attr("data-subcat");
                      console.log(subcat);
                      //var layerClicked=window[''+layerName];
                      var layerClicked=eval(layerName);
                  //     console.log(layerClicked);
                  var url =base_url+"/risk_profile/"+layerName;
                  $.ajax({
                      url: url,
                      //data:{"layer_icon":layer_icon, "data":data,"i":i},
                      subcat1:subcat,
                      // indexValue: i,
                      // layer_icon: layer_icon,
                      success: function(response) {

                        CreateChartData(response,this.subcat1);
                        // console.log(response);

                      }
                    });

                      if(map.hasLayer(layerClicked)){
                        // console.log(layerClicked+" clicked");
                        map.removeLayer(layerClicked);
                        $("."+layerName+"_activeclass").removeClass("active");
                        $('#'+layerName+'_legend').remove();
                        for(var i=0;i<visible_layers.length;i++){
                          if(visible_layers[i].layerName==layerName){
                            visible_layers.splice(i,1);
                          }
                        }

                      }else{

                        //console.log(" ntclicked");
                        map.addLayer(layerClicked);
                            $("."+layerName+"_activeclass").addClass("active");
                            let url= geo_url +'?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=10&&crossOrigin=Anonymous&LAYER='+layerName+'&';
                          //  console.log(url)
                            info._div.innerHTML = info._div.innerHTML+'<div id="'+layerName+'_legend" style="background:white; padding:5px;"><h6>'+layerName+'</h6><img  src="'+url+'"/></div>';
                       //console.log(info._div.innerHTML)
                       visible_layers.push({"layerName":layerName,"url":geo_url,"workspace":geo_workspace})
                        //map.BringToFront();
                      }
                    //  console.log(visible_layers);
                    });
            // method that we will use to update the control based on feature properties passed
                    //end
                /* var wfst = new L.WFST(
                    {
                      url: 'http://139.59.67.104:8080/geoserver/ows',
                      typeNS: 'Naxa',
                      typeName: 'educatinal_institutions',
                      crs: L.CRS.EPSG4326,
                      geometryField: 'the_geom',
                      filter: filter1,//new L.Filter.BBox('ogr_geometry', map.getBounds(), L.CRS.EPSG4326),
                      style: {
                        color: 'blue',
                        weight: 2
                      }
                    }
                ).on('load', function (feature, layer) {
                    console.log(feature);
                    //map.fitBounds(wfst.getBounds());
                }); */
            ///
                /*
                var popup = new L.Popup();
                wfst.on('click', function(e){
                    console.log(e);
                  popup
                    .setLatLng(e.latlng)
                    .setContent('You clicked on boundary layer at '+ e.latlng.toString())
                    .openOn(map);
                });
             */

            $('.subcat').on('click',function(){
                if($(this).hasClass('geoserver_False')){

                    let layer_name =$(this).attr("value").replace(" ","_");
                    // console.log("layergrou", window[layer_name])
                    if(map.hasLayer(window[layer_name])){
                        // console.log('remove');
                      map.removeLayer(window[layer_name]);
                    }else{
                        // console.log('add');
                      map.addLayer(window[layer_name]);

                    }
                    // window[layer_name].addTo(map)
                }
                else{
                                var filter_value= $(this).attr("value")

                                //var filter = new L.Filter.GmlObjectID(1);
                                var filter1 = new L.Filter.EQ('a2', filter_value);
                            filter1.toGml();
                            const wfstPointOptions = {
                                crs: L.CRS.EPSG4326,
                            showExisting: true,
                            geometryField: 'the_geom',
                            url: 'http://139.59.67.104:8080/geoserver/ows',
                            typeNS: 'Naxa',
                            typeName: 'educatinal_institutions',
                            filter: filter1,
                            //maxFeatures: 90,
                            opacity: 1,
                            style: function(layer) {
                                // you can use if statemt etc
                                return {
                                color: 'blue',
                                weight: 1
                                }
                            },
                            };
                            if(map.hasLayer(window[filter_value])){
                                map.removeLayer(window[filter_value])
                            }
                            else{
                            window[filter_value] = new L.WFST(wfstPointOptions, new L.Format.GeoJSON({
                            crs: L.CRS.EPSG4326,
                            pointToLayer(geoJsonPoint, latlng) {
                                /* const layer = new L.CircleMarker(latlng, {
                                radius: 10,
                                }); */
                                var divicon = L.divIcon({
                                            className: 'humanitarian-icon-Education',
                                });
                                var marker = L.marker(latlng,{icon:divicon});
                                return marker;
                            },
                            }));
                            window[filter_value].addTo(map);
                            }
            //
                }
            })
          function getLayersInsidePolygon(coords,visible_layers){
            console.log("visible layers  ",visible_layers.length);
            $('#filtered_layer_list').html('');
            for(var i=0;i<visible_layers.length;i++){
              //  var filter3 = new L.Filter.Within('location', L.polygon([L.latLng(27.459539332717906,86.66015625000001),L.latLng(26.78484736105119,87.78076171875001),L.latLng(27.039556602163195,88.60473632812501)]), L.CRS.EPSG4326);
                var filter3 = new L.Filter.Within('location', L.polygon([coords]), L.CRS.EPSG4326);
                //var filter4 = new L.Filter.Within('location', L.polygon([L.latLng(27.68307, 85.4635),L.latLng(27.7213, 85.4914),L.latLng(27.72418, 85.44831)]), L.CRS.EPSG4326);
                 //filter3.toGml();

                 //filter1.toGml();
                 //console.log(b);



                   window[visible_layers[i]['layerName']+"_filteredLayers"] = new L.WFST(
                        {
                          url: visible_layers[i]['url'],
                          typeNS: visible_layers[i]['workspace'],
                          typeName: visible_layers[i]['layerName'],
                          crs: L.CRS.EPSG4326,
                          geometryField: 'location',
                          filter: filter3,//new L.Filter.BBox('ogr_geometry', map.getBounds(), L.CRS.EPSG4326),
                          style: {
                            color: 'blue',
                            weight: 2
                          }
                        },
                        new L.Format.GeoJSON({
                          crs: L.CRS.EPSG4326,
                          pointToLayer(geoJsonPoint, latlng) {
                            const layer = new L.CircleMarker(latlng, {
                              radius: 8,
                            });
                            return layer;
                          },
                        })

                    ).addTo(map).on('load', function (feature, layer) {
                        console.log(feature);
                        //console.log(feature.target._layers[0].feature.properties);
                        console.log(feature.target._layers);
                        $.each(feature.target._layers, function (i) {
                          console.log(feature.target._layers[i].feature.properties.name)

                          var list_item='<li><a href="#" target="">'+feature.target._layers[i].feature.properties.name+'</a></li>';

                          $('#filtered_layer_list').append(list_item);

                        });
                        $('#filtered_layer_list_container').css('display','block');
                        //map.fitBounds(window[visible_layers[i]['layerName']+"_filteredLayers"].getBounds());
                    });
                map.removeLayer(window[visible_layers[i]['layerName']]);
                $("."+visible_layers[i]['layerName']+"_activeclass").removeClass("active");
                $('#'+visible_layers[i]['layerName']+'_legend').remove();

            }



        }

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            var drawControl = new L.Control.Draw({
                  position:"topleft",
                  draw: {

                     // disable toolbar item by setting it to false
                     polyline: false,
                     circle: false, // Turns off this drawing tool
                     rectangle: false,
                     marker: false,
                     },
                     edit: {
                              featureGroup: drawnItems
                          }

                  });

            map.addControl(drawControl);

            map.on('draw:created', function(e) {
              var type = e.layerType,
                layer = e.layer;
              drawnItems.addLayer(layer);
              layer.bindPopup("sadfdsa");
              layer.on('click',function(){
                console.log('delete clicked');
                setTimeout(function(){

                  if($.isEmptyObject(drawnItems._layers)){
                      console.log($.isEmptyObject(drawnItems._layers));
                        for(var i=0;i<visible_layers.length;i++){

                          if(map.hasLayer(window[visible_layers[i]['layerName']+"_filteredLayers"])){

                            map.removeLayer( window[visible_layers[i]['layerName']+"_filteredLayers"]);

                          }

                        }
                        visible_layers=[];
                        $('#filtered_layer_list').html('');
                        $('#filtered_layer_list_container').css('display','none');
                  }


                }, 100);

              });
              console.log(e.layer.editing.latlngs[0][0]);
              var coordinates=e.layer.editing.latlngs[0][0];
              getLayersInsidePolygon(coordinates,visible_layers)
              map.fitBounds(layer.getBounds());
            });
        //
        // $.isEmptyObject(drawnItems._layers);
        // drawnItems.click(function(){
        //   console.log('delete clicked');
        // });

            // map.on('click', function(){
            // 	window.console.log('click');
            // });
            //
            // map.on('touchstart', function(){
            // 	window.console.log('touchstart');
            // });



          //  var filter1 = new L.Filter.EQ('name', 'Modi Bridge');
            var filter3 = new L.Filter.Within('location', L.polygon([L.latLng(27.459539332717906,86.66015625000001),L.latLng(26.78484736105119,87.78076171875001),L.latLng(27.039556602163195,88.60473632812501)]), L.CRS.EPSG4326);
          //  var filter4 = new L.Filter.DWithin('the_geom', L.polygon([L.latLng(27.68307, 85.4635),L.latLng(27.7213, 85.4914),L.latLng(27.72418, 85.44831)]), L.CRS.EPSG4326, 0.01);
             //filter3.toGml();


             //console.log(b);



               // var wfst = new L.WFST(
               //      {
               //        url: 'http://139.59.67.104:8080/geoserver/ows',
               //        typeNS: 'neoc',
               //        typeName: 'Bridge',
               //        crs: L.CRS.EPSG4326,
               //        geometryField: 'location',
               //        filter: filter3,//new L.Filter.BBox('ogr_geometry', map.getBounds(), L.CRS.EPSG4326),
               //        style: {
               //          color: 'blue',
               //          weight: 2
               //        }
               //      }
               //
               //  ).addTo(map).on('load', function (feature, layer) {
               //    //  console.log(feature);
               //      map.fitBounds(wfst.getBounds());
               //  });


//chart start--
function createChart(dataset){


// define data
// var dataset = [
//     {label: "Assamese", count: 13},
//     {label: "Bengali", count: 83},
//     {label: "Bodo", count: 1.4},
//     {label: "Dogri", count: 2.3},
//     {label: "Gujarati", count: 46},
//     {label: "Hindi", count: 300},
//     {label: "Kannada", count: 38},
//     {label: "Kashmiri", count: 5.5},
//     {label: "Konkani", count: 5},
//     {label: "Maithili", count: 20},
//     {label: "Malayalam", count: 33},
//     {label: "Manipuri", count: 1.5},
//     {label: "Marathi", count: 72},
//     {label: "Nepali", count: 2.9},
//     {label: "Oriya", count: 33},
//     {label: "Punjabi", count: 29},
//     {label: "Sanskrit", count: 0.01},
//     {label: "Santhali", count: 6.5},
//     {label: "Sindhi", count: 2.5},
//     {label: "Tamil", count: 61},
//     {label: "Telugu", count: 74},
//     {label: "Urdu", count: 52}
//   ];

// chart dimensions
var width = 300;
var height = 160;

// a circle chart needs a radius
var radius = Math.min(width, height) / 2;

// legend dimensions
var legendRectSize = 10; // defines the size of the colored squares in legend
var legendSpacing = 2; // defines spacing between squares

// define color scale
var color = d3.scaleOrdinal(d3.schemeCategory20c);
// more color scales: https://bl.ocks.org/pstuffa/3393ff2711a53975040077b7453781a9

var svg = d3.select('#chart') // select element in the DOM with id 'chart'
  .append('svg') // append an svg element to the element we've selected
  .attr('width', width) // set the width of the svg element we just added
  .attr('height', height) // set the height of the svg element we just added
  .append('g') // append 'g' element to the svg element
  .attr('transform', 'translate(' + (width / 3) + ',' + (height / 2) + ')'); // our reference is now to the 'g' element. centerting the 'g' element to the svg element

var arc = d3.arc()
  .innerRadius(30) // none for pie chart
  .outerRadius(radius); // size of overall chart

var pie = d3.pie() // start and end angles of the segments
  .value(function(d) { return d.count; }) // how to extract the numerical data from each entry in our dataset
  .sort(null); // by default, data sorts in oescending value. this will mess with our animation so we set it to null

// define tooltip
var tooltip = d3.select('#chart') // select element in the DOM with id 'chart'
  .append('div') // append a div element to the element we've selected
  .attr('class', 'tooltip_chart'); // add class 'tooltip' on the divs we just selected

tooltip.append('div') // add divs to the tooltip defined above
  .attr('class', 'label'); // add class 'label' on the selection

tooltip.append('div') // add divs to the tooltip defined above
  .attr('class', 'count'); // add class 'count' on the selection

tooltip.append('div') // add divs to the tooltip defined above
  .attr('class', 'percent'); // add class 'percent' on the selection

// Confused? see below:

// <div id="chart">
//   <div class="tooltip">
//     <div class="label">
//     </div>
//     <div class="count">
//     </div>
//     <div class="percent">
//     </div>
//   </div>
// </div>

dataset.forEach(function(d) {
  d.count = +d.count; // calculate count as we iterate through the data
  d.enabled = true; // add enabled property to track which entries are checked
});

// creating the chart
var path = svg.selectAll('path') // select all path elements inside the svg. specifically the 'g' element. they don't exist yet but they will be created below
  .data(pie(dataset)) //associate dataset wit he path elements we're about to create. must pass through the pie function. it magically knows how to extract values and bakes it into the pie
  .enter() //creates placeholder nodes for each of the values
  .append('path') // replace placeholders with path elements
  .attr('d', arc) // define d attribute with arc function above
  .attr('fill', function(d) { return color(d.data.label); }) // use color scale to define fill of each label in dataset
  .each(function(d) { this._current - d; }); // creates a smooth animation for each track

// mouse event handlers are attached to path so they need to come after its definition
path.on('mouseover', function(d) {  // when mouse enters div
 var total = d3.sum(dataset.map(function(d) { // calculate the total number of tickets in the dataset
  return (d.enabled) ? d.count : 0; // checking to see if the entry is enabled. if it isn't, we return 0 and cause other percentages to increase
  }));
 var percent = Math.round(1000 * d.data.count / total) / 10; // calculate percent
 tooltip.select('.label').html(d.data.label); // set current label
 tooltip.select('.count').html('$' + d.data.count); // set current count
 tooltip.select('.percent').html(percent + '%'); // set percent calculated above
 tooltip.style('display', 'block'); // set display
});

path.on('mouseout', function() { // when mouse leaves div
  tooltip.style('display', 'none'); // hide tooltip for that element
 });

path.on('mousemove', function(d) { // when mouse moves
  console.log(d3.event.layerY );
  tooltip.style('top', (d3.event.layerY + 10) + 'px') // always 10px below the cursor
    .style('left', (d3.event.layerX + 10) + 'px'); // always 10px to the right of the mouse
  });

// define legend
var legend = svg.selectAll('.legend') // selecting elements with class 'legend'
  .data(color.domain()) // refers to an array of labels from our dataset
  .enter() // creates placeholder
  .append('g') // replace placeholders with g elements
  .attr('class', 'legend') // each g is given a legend class
  .attr('transform', function(d, i) {
    var height = legendRectSize + legendSpacing; // height of element is the height of the colored square plus the spacing
    var offset =  height * color.domain().length / 3; // vertical offset of the entire legend = height of a single element & half the total number of elements
    var horz = 10 * legendRectSize; // the legend is shifted to the left to make room for the text
    var vert = i * height - offset; // the top of the element is hifted up or down from the center using the offset defiend earlier and the index of the current element 'i'
      return 'translate(' + horz + ',' + vert + ')'; //return translation
   });

// adding colored squares to legend
legend.append('rect') // append rectangle squares to legend
  .attr('width', legendRectSize) // width of rect size is defined above
  .attr('height', legendRectSize) // height of rect size is defined above
  .style('fill', color) // each fill is passed a color
  .style('stroke', color) // each stroke is passed a color
  .on('click', function(label) {
    var rect = d3.select(this); // this refers to the colored squared just clicked
    var enabled = true; // set enabled true to default
    var totalEnabled = d3.sum(dataset.map(function(d) { // can't disable all options
      return (d.enabled) ? 1 : 0; // return 1 for each enabled entry. and summing it up
    }));

    if (rect.attr('class') === 'disabled') { // if class is disabled
      rect.attr('class', ''); // remove class disabled
    } else { // else
      if (totalEnabled < 2) return; // if less than two labels are flagged, exit
      rect.attr('class', 'disabled'); // otherwise flag the square disabled
      enabled = false; // set enabled to false
    }

    pie.value(function(d) {
      if (d.label === label) d.enabled = enabled; // if entry label matches legend label
        return (d.enabled) ? d.count : 0; // update enabled property and return count or 0 based on the entry's status
    });

    path = path.data(pie(dataset)); // update pie with new data

    path.transition() // transition of redrawn pie
      .duration(750) //
      .attrTween('d', function(d) { // 'd' specifies the d attribute that we'll be animating
        var interpolate = d3.interpolate(this._current, d); // this = current path element
        this._current = interpolate(0); // interpolate between current value and the new value of 'd'
        return function(t) {
          return arc(interpolate(t));
        };
      });
  });

// adding text to legend
legend.append('text')
  .attr('x', legendRectSize + legendSpacing)
  .attr('y', legendRectSize - legendSpacing)
  .text(function(d) { return d; }); // return label

}
//chart end





          })//document ready
            console.log("hello")
            </script>

</body>

</html>
